{% extends 'base.html' %}
{% load static %}


{% block css %}
<style>
    .settings-modal-active-link {
        background-color: var(--color-primary-600);
        color: var(--color-white);
    }

    .htmx-indicator {
        display: none;
    }
    .htmx-indicator .htmx-request {
        display: inline-block;
    }
</style>
{% endblock css %}


{% block base %}
    {% include 'components/dashboard/settings-modal.html' %}
    <div x-data="layout()" class="h-screen flex">
        <div
            x-show="sidebarOpen"
            x-transition.opacity
            class="fixed inset-0 z-30 bg-black/50 md:hidden"
            @click="sidebarOpen = false"
        ></div>

        <!-- Sidebar -->
        <aside 
            class="fixed md:static md:flex inset-y-0 left-0 z-30 bg-white border-r border-border-200 transform transition-all duration-200 ease-in-out"
            :class="[
                sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0',
                sidebarCollapsed ? 'w-14 md:w-14' : 'w-64 md:w-64'
            ]"
        >
            <div class="flex flex-col w-full h-full overflow-y-auto">
                <!-- Жоғарғы блок -->
                <div class="flex-1 space-y-2">
                    <!-- Логотип пен навигациялық батырмалар -->
                    <div 
                        class="sticky top-0 flex items-center p-2"
                        :class="sidebarCollapsed ? 'justify-center': 'justify-between h-14'"
                    >
                        <div class="flex" :class="!sidebarCollapsed && 'pl-2'">
                            <a 
                                href="{% url 'dashboard:dashboard' %}"
                                class="inline-block rounded-xl transition-all active:scale-95"
                                x-show="!sidebarCollapsed"
                            >
                                <img src="{% static 'images/logo.svg' %}" class="w-16" alt="">
                            </a>
                            <button
                                class="inline-block rounded-xl transition-all hover:bg-primary-50 hover:text-primary-600 active:scale-95 cursor-e-resize"
                                @click="sidebarCollapsed = !sidebarCollapsed"
                                x-show="sidebarCollapsed"
                            >
                                <img src="{% static 'images/icon.png' %}" class="w-8 h-8" alt="">
                            </button>
                        </div>

                        <button 
                            type="button"
                            class="
                                flex p-2 rounded-xl text-muted transition-all cursor-w-resize hover:bg-primary-50 hover:text-primary-600 active:scale-95"
                            @click="sidebarCollapsed = !sidebarCollapsed"
                            x-show="!sidebarCollapsed"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                class="lucide lucide-panel-right-icon lucide-panel-right">
                                <rect width="18" height="18" x="3" y="3" rx="2" />
                                <path d="M15 3v18" />
                            </svg>
                        </button>
                    </div>

                    <!-- Навигация -->
                    <ul class="grid gap-1 px-2">
                        <li>
                            <a 
                                href="{% url 'dashboard:dashboard' %}"
                                class="
                                    flex gap-2 items-center rounded-xl whitespace-nowrap transition-all active:scale-95
                                    {% if request.path == '/dashboard/' %}bg-primary-600 text-white hover:bg-primary-600{% else %}hover:bg-primary-50{% endif %}
                                "
                                :class="sidebarCollapsed ? 'p-2 justify-center': 'px-4 py-2'"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house-icon lucide-house">
                                 <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8" />
                                 <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                              </svg>
                                <span :class="sidebarCollapsed ? 'hidden' : 'block'">Басты бет</span>
                            </a>
                        </li>
                        <li>
                            <a 
                                href="{% url 'dashboard:game_tasks' %}"
                                class="
                                    flex gap-2 items-center rounded-xl whitespace-nowrap transition-all active:scale-95
                                    {% if request.path == '/dashboard/game-tasks/' %}bg-primary-600 text-white hover:bg-primary-600{% else %}hover:bg-primary-50{% endif %}
                                "
                                :class="sidebarCollapsed ? 'p-2 justify-center': 'px-4 py-2'"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="lucide lucide-gamepad-directional-icon lucide-gamepad-directional">
                                    <path
                                        d="M11.146 15.854a1.207 1.207 0 0 1 1.708 0l1.56 1.56A2 2 0 0 1 15 18.828V21a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-2.172a2 2 0 0 1 .586-1.414z" />
                                    <path
                                        d="M18.828 15a2 2 0 0 1-1.414-.586l-1.56-1.56a1.207 1.207 0 0 1 0-1.708l1.56-1.56A2 2 0 0 1 18.828 9H21a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1z" />
                                    <path
                                        d="M6.586 14.414A2 2 0 0 1 5.172 15H3a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h2.172a2 2 0 0 1 1.414.586l1.56 1.56a1.207 1.207 0 0 1 0 1.708z" />
                                    <path
                                        d="M9 3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2.172a2 2 0 0 1-.586 1.414l-1.56 1.56a1.207 1.207 0 0 1-1.708 0l-1.56-1.56A2 2 0 0 1 9 5.172z" />
                                </svg>
                                <span :class="sidebarCollapsed ? 'hidden' : 'block'">Ойын тапсырмалары</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Төменгі блок -->
                <div 
                    x-data="{ openUserDropdown: false }"
                    class="sticky bottom-0 p-2"
                >
                    <button
                        @click="openUserDropdown = !openUserDropdown"
                        class="w-full flex items-center gap-2 hover:bg-primary-50 rounded-xl active:scale-95 cursor-pointer transition-all"
                        :class="sidebarCollapsed ? 'px-0 py-1 justify-center' : 'p-2'"
                    >
                        <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary-200">
                            {% if user.avatar %}
                                <img class="w-full h-full" src="{{ user.avatar.url }}" alt="user photo">
                            {% else %}
                                <div class="w-full h-full bg-primary-600 flex items-center justify-center text-white text-xs">
                                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="overflow-hidden text-left" :class="sidebarCollapsed ? 'hidden' : 'block'">
                            <h4 class="font-medium">{{ user.get_full_name }}</h4>
                            <span class="block text-xs text-muted">{{ user.email }}</span>
                        </div>
                    </button>

                    <div
                        x-show="openUserDropdown" 
                        @click.outside="openUserDropdown = false"
                        :class="sidebarCollapsed ? 'bottom-2 left-[52px]' : 'bottom-[72px]'"
                        class="fixed z-20 bg-white p-2 rounded-xl overflow-hidden shadow-xs w-60 border border-border-200"
                    >
                        <ul>
                            <li>
                                <a 
                                    href="#settings/account/" 
                                    id="settingsTrigger"
                                    hx-get="{% url 'dashboard:account' %}" 
                                    hx-target="#settingsContent" 
                                    hx-swap="innerHTML" 
                                    class="flex gap-1 items-center p-2 rounded-xl transition-all hover:bg-primary-50"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                        class="lucide lucide-settings-icon lucide-settings">
                                        <path
                                            d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
                                        <circle cx="12" cy="12" r="3" />
                                    </svg>
                                    <span>Баптаулар</span>
                                </a>
                            </li>
                            <li>
                                <form action="{% url 'main:logout' %}">
                                    <button 
                                        type="submit" 
                                        class="w-full flex gap-1 items-center p-2 rounded-xl transition-all cursor-pointer hover:bg-primary-50"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out">
                                            <path d="m16 17 5-5-5-5" />
                                            <path d="M21 12H9" />
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                        </svg>
                                        <span>Шығу</span>
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Header -->
        <div
            x-init="headerScrolled = $el.scrollTop > 0"
            @scroll="headerScrolled = $event.target.scrollTop > 0"
            class="flex-1 h-screen overflow-y-auto" 
        >
            <header 
                class="sticky top-0 h-14 z-20 flex items-center bg-white transition-all duration-200 border-border-50"
                :class="headerScrolled ? 'border-b border-border-200' : 'border-b-0'"
            >
                <div class="max-w-screen-2xl px-4 flex justify-between">
                    <button 
                        class="md:hidden flex items-center justify-center p-2 rounded-xl transition-all cursor-pointer hover:bg-primary-200 hover:text-primary-600 active:scale-95"
                        @click="sidebarOpen = true"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu-icon lucide-menu">
                            <path d="M4 5h16" />
                            <path d="M4 12h16" />
                            <path d="M4 19h16" />
                        </svg>
                    </button>
                </div>
            </header>

            <div class="w-full flex-1">
                {% block dashboard_layout %}
                {% endblock dashboard_layout %}
            </div>
        </div>
    </div>
{% endblock base %}


{% block js %}
    <!-- Sidebar компонентінің күйін сақтау -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('layout', () => ({
                sidebarOpen: false,
                sidebarCollapsed: false,
                headerScrolled: false,

                init() {
                    const saved = localStorage.getItem('oqu_sidebar_collapsed');
                    if (saved !== null) {
                        this.sidebarCollapsed = saved === '1';
                    }
                    this.$watch('sidebarCollapsed', (value) => {
                        localStorage.setItem('oqu_sidebar_collapsed', value ? '1' : '0');
                    });
                },
            }));
        });
    </script>

    <!-- Модальды терезені hash URL (#) арқылы басқару және сол күйін сақтау  -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("settings-modal");
            const trigger = document.getElementById("settingsTrigger");
            const closeBtn = document.getElementById("settingsClose");
            const tabs = document.querySelectorAll(".settings-tab");
            const contentSel = "#settingsContent";

            let baseUrl = null;

            function mapHashToUrl(hash) {
                switch (hash) {
                    case "#settings/account":
                        return "/d/settings/account";
                    case "#settings/security/":
                        return "/d/settings/security";
                    default:
                        return null;
                }
            }

            function loadContent(hash) {
                const url = mapHashToUrl(hash);
                if (!url || !window.htmx) return;
                window.htmx.ajax("GET", url, { target: contentSel });
            }

            function setActiveTab(hash) {
                tabs.forEach(a => {
                    const isActive = a.getAttribute("href") === hash;
                    a.classList.toggle("settings-modal-active-link", isActive);
                });
            }

            function showModal() {
                if (!modal) return;
                modal.classList.remove("hidden");
                modal.classList.add("flex");
            }

            function hideModal() {
                if (!modal) return;
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            function openModal(hash) {
                if (!baseUrl) {
                    baseUrl = window.location.pathname + window.location.search;
                }

                const targetHash = hash || "#settings/account";
                if (window.location.hash !== targetHash) {
                    history.replaceState(null, "", targetHash);
                }

                showModal();
                setActiveTab(targetHash);
                loadContent(targetHash);
            }

            function closeModal() {
                hideModal();
                if (baseUrl && window.location.hash.startsWith("#settings/")) {
                    history.replaceState(null, "", baseUrl);
                }
            }

            if (trigger) {
                trigger.addEventListener("click", function (e) {
                    e.preventDefault();              
                    openModal("#settings/account");
                });
            }

            tabs.forEach(a => {
                a.addEventListener("click", function (e) {
                    e.preventDefault();
                    const hash = a.getAttribute("href");
                    if (!hash.startsWith("#settings/")) return;

                    if (window.location.hash !== hash) {
                        history.replaceState(null, "", hash);
                    }
                    setActiveTab(hash);
                    loadContent(hash);
                });
            });

            if (closeBtn) {
                closeBtn.addEventListener("click", function () {
                    closeModal();
                });
            }

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                    e.preventDefault();
                    closeModal();
                }
            });

            if (window.location.hash.startsWith("#settings/")) {
                openModal(window.location.hash);
            }
        });
    </script>

    {% block extra_js %}
    {% endblock extra_js %}
{% endblock js %}