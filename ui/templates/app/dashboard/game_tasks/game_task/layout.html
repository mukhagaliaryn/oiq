{% extends 'layouts/dashboard_layout.html' %}

{% block title %}{{ game_task }}{% endblock title %}

{% block dashboard_layout %}
<div class="max-w-5xl w-full mx-auto p-4">
    <div class="flex items-start justify-between py-8">
        <div class="flex items-start gap-4">
            <div class="w-36 h-36 flex justify-center items-center rounded-xl bg-primary-50">
                <lord-icon
                    src="https://cdn.lordicon.com/xzvgfwwv.json"
                    trigger="loop"
                    colors="primary:#ebe6ef,secondary:#4f46e5"
                    style="width:128px; height: 128px">
                </lord-icon>
            </div>
            <div class="grid gap-2 items-start">
                <h2 class="text-xl md:text-2xl font-black">{{ game_task.name }}</h2>
                <div class="flex">
                    <div class="flex gap-1 items-center bg-primary-100 py-1 px-2 rounded-xl text-primary-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-gamepad-directional-icon lucide-gamepad-directional">
                            <path
                                d="M11.146 15.854a1.207 1.207 0 0 1 1.708 0l1.56 1.56A2 2 0 0 1 15 18.828V21a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-2.172a2 2 0 0 1 .586-1.414z" />
                            <path
                                d="M18.828 15a2 2 0 0 1-1.414-.586l-1.56-1.56a1.207 1.207 0 0 1 0-1.708l1.56-1.56A2 2 0 0 1 18.828 9H21a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1z" />
                            <path
                                d="M6.586 14.414A2 2 0 0 1 5.172 15H3a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h2.172a2 2 0 0 1 1.414.586l1.56 1.56a1.207 1.207 0 0 1 0 1.708z" />
                            <path
                                d="M9 3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2.172a2 2 0 0 1-.586 1.414l-1.56 1.56a1.207 1.207 0 0 1-1.708 0l-1.56-1.56A2 2 0 0 1 9 5.172z" />
                        </svg>
                        <span class="block text-xs">{{ game_task.activity.get_activity_type_display }}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="flex items-center text-muted text-xs gap-1 py-1 px-2 rounded-xl bg-secondary-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-circle-question-mark-icon lucide-circle-question-mark">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                            <path d="M12 17h.01" />
                        </svg>
                        <span>{{ game_task.questions.count }}- сұрақ</span>
                    </div>

                    <div class="flex items-center text-muted text-xs gap-1 py-1 px-2 rounded-xl bg-secondary-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-icon lucide-users">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <path d="M16 3.128a4 4 0 0 1 0 7.744" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <circle cx="9" cy="7" r="4" />
                        </svg>
                        <span>{{ game_task.total_participants }}- қатысушы</span>
                    </div>
                </div>
                {% if game_task.description %}
                    <div class="max-w-sm w-full text-muted">
                        {{ game_task.description|safe }}
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="grid gap-4">
            <form
                method="post"
                action="{% url 'dashboard:session_create' game_task.id %}"
                target="_blank"
            >
                {% csrf_token %}
                <input type="hidden" name="duration" value="10">

                <button
                    type="submit"
                    class="relative grid group cursor-pointer"
                >
                    <span class="absolute -bottom-1.5 w-full h-full rounded-xl bg-primary-800 group-active:h-0"></span>
                    <span class="
                        relative w-full flex gap-2 justify-center items-center px-4 py-2 rounded-xl bg-primary-600 text-white font-medium 
                        group-hover:bg-primary-500 group-active:translate-y-1.5
                        "
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-circle-fading-plus-icon lucide-circle-fading-plus">
                            <path d="M12 2a10 10 0 0 1 7.38 16.75" />
                            <path d="M12 8v8" />
                            <path d="M16 12H8" />
                            <path d="M2.5 8.875a10 10 0 0 0-.5 3" />
                            <path d="M2.83 16a10 10 0 0 0 2.43 3.4" />
                            <path d="M4.636 5.235a10 10 0 0 1 .891-.857" />
                            <path d="M8.644 21.42a10 10 0 0 0 7.631-.38" />
                        </svg>
                        Жаңа сессия
                    </span>
                </button>
            </form>

            <div x-data="{ open: false, confirmDelete: false }" id="gt_{{ game_task.id }}" class="relative">
                <button
                    x-on:click.prevent="open = !open"
                    type="button"
                    class="relative grid group w-full cursor-pointer"
                >
                    <span class="absolute -bottom-1.5 w-full h-full rounded-xl bg-secondary-300 group-active:h-0"></span>
                    <span class="
                        relative w-full flex gap-2 justify-center px-4 py-2 rounded-xl bg-white border border-border-300 font-medium 
                        group-hover:bg-secondary-50 group-active:translate-y-1.5
                        "
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings">
                            <path
                                d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                        Баптаулар
                    </span>
                </button>

                <!-- Әрекеттер -->
                <div
                    x-show="open"
                    x-transition
                    x-on:click.outside="open = false"
                    class="absolute top-12 left-1/2 -translate-x-1/2 w-40 bg-white border border-border-200 rounded-xl shadow-xs z-30"
                >
                    <ul class="p-2">
                        <li>
                            <a 
                                href="{% url 'dashboard:game_task_edit' pk=game_task.pk %}"
                                class="flex w-full px-4 py-2 rounded-xl cursor-pointer text-subtle hover:bg-secondary-100"
                            >
                                Өзгерту
                            </a>
                        </li>
                        <li>
                            <button 
                                @click.prevent="open = false; confirmDelete = true"
                                class="flex w-full px-4 py-2 rounded-xl cursor-pointer text-destructive hover:bg-red-100"
                            >
                                Жою
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Жоюды растау -->
                <div
                    x-show="confirmDelete"
                    x-transition.opacity
                    x-cloak
                    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
                    @keydown.escape.window="confirmDelete = false"
                >
                    <div class="grid gap-4 bg-white rounded-2xl shadow-lg w-full max-w-md p-6">
                        <div class="space-y-2">
                            <h3 class="font-black text-xl line-clamp-1">Жоюды растау</h3>
                            <p class="text-muted">
                                Шынымен жойғыңыз келе ме? Бұл әрекет қайтарылмайды.
                            </p>
                        </div>
                        
                        <div class="flex justify-end gap-2">
                            <button
                                type="button"
                                @click="confirmDelete = false"
                                class="flex px-4 py-2 font-medium rounded-xl border border-border-200 hover:bg-secondary-100 cursor-pointer"
                            >
                                Болдырмау
                            </button>
                            <form
                                hx-post="{% url 'dashboard:game_task_delete' game_task.id %}"
                                method="post"
                                hx-on::after-request="
                                    document.getElementById('gt_{{ game_task.id }}')?.remove();
                                    showFlash('Ойын тапсырмасы өшірілді!', 'success');
                                    history.replaceState({}, '', '{% url 'dashboard:dashboard' %}');
                                    window.location.reload();
                                "
                                hx-swap="none"
                            >
                                {% csrf_token %}
                                <button
                                    type="submit"
                                    class="flex px-4 py-2 font-medium rounded-xl bg-red-600 text-white hover:bg-red-700 cursor-pointer"
                                >
                                    Иә, жою
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid gap-4">
        <nav class="flex">
            {% url 'dashboard:game_task_detail' pk=game_task.pk as game_task_detail %}
            <a 
                href="{{ game_task_detail }}" 
                class=
                "
                    flex gap-2 items-center px-4 py-2 border-b-4 transition-all 
                    {% if request.path == game_task_detail %}border-b-primary-600 hover:bg-primary-50{% else %}border-b-transparent hover:bg-primary-50{% endif %}
                "
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-chart-bar-increasing-icon lucide-chart-bar-increasing">
                    <path d="M3 3v16a2 2 0 0 0 2 2h16" />
                    <path d="M7 11h8" />
                    <path d="M7 16h12" />
                    <path d="M7 6h3" />
                </svg>
                <span>Сессиялар</span>

                <span class="font-medium">({{ sessions.count }})</span>
            </a>

            {% url 'dashboard:game_task_questions' pk=game_task.pk as game_task_questions %}
            <a 
                href="{{ game_task_questions }}" 
                class="
                    flex gap-2 items-center px-4 py-2 border-b-4 transition-all 
                    {% if request.path == game_task_questions %}border-b-primary-600 hover:bg-primary-50{% else %}border-b-transparent hover:bg-primary-50{% endif %}    
                "
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-circle-question-mark-icon lucide-circle-question-mark">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                    <path d="M12 17h.01" />
                </svg>
                <span>Сұрақтар</span>
                <span class="font-medium">({{ questions.count }})</span>
            </a>
        </nav>

        <main class="flex-1">
            {% block layout %}
            {% endblock layout %}
        </main>
    </div>
</div>
{% endblock dashboard_layout %}
