{% extends 'base.html' %}
{% load static %}

{% block title %}#{{ session.id }} - {{ game_task.name }} – Күту бөлмесі{% endblock title %}

{% block base %}
<div class="w-full min-h-screen relative flex justify-center items-center p-4">
    <div class="max-w-3xl w-full mx-auto space-y-8">
        <img src="{% static 'images/logo.svg' %}" alt="" class="w-36 flex mx-auto" />
        <div class="grid gap-4 text-center">
            <h1 class="text-xl md:text-2xl lg:text-3xl xl:text-4xl font-black">#{{ session.id }} - {{ game_task.name }}</h1>

            <div class="flex gap-2 items-center justify-center">
                <div class="inline-flex items-center gap-1 py-2 px-4 rounded-full border border-border-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-icon lucide-loader">
                        <path d="M12 2v4" />
                        <path d="m16.2 7.8 2.9-2.9" />
                        <path d="M18 12h4" />
                        <path d="m16.2 16.2 2.9 2.9" />
                        <path d="M12 18v4" />
                        <path d="m4.9 19.1 2.9-2.9" />
                        <path d="M2 12h4" />
                        <path d="m4.9 4.9 2.9 2.9" />
                    </svg>
                    <div class="flex flex-col text-left">
                        <span class="text-muted text-xs">Статус</span>
                        <span class="font-bold">{{ session.get_status_display }}</span>
                    </div>
                </div>
                
                <div class="inline-flex items-center gap-1 py-2 px-4 rounded-full border border-border-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-timer-icon lucide-timer">
                        <line x1="10" x2="14" y1="2" y2="2" />
                        <line x1="12" x2="15" y1="14" y2="11" />
                        <circle cx="12" cy="14" r="8" />
                    </svg>
                    <div class="flex flex-col text-left">
                        <span class="text-muted text-xs">Таймер</span>
                        <span class="font-bold">
                            {% if session.play_mode == 'speed' %}
                                {{ session.remaining_mm_ss }}
                            {% else %}
                                Шектеусіз
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="inline-flex items-center gap-1 py-2 px-4 rounded-full border border-border-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-infinity-icon lucide-infinity">
                        <path d="M6 16c5 0 7-8 12-8a4 4 0 0 1 0 8c-5 0-7-8-12-8a4 4 0 1 0 0 8" />
                    </svg>
                    <div class="flex flex-col text-left">
                        <span class="text-muted text-xs">Ойын режимі</span>
                        <span class="font-bold">{{ session.get_play_mode_display }}</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 items-center justify-center">
                <form
                    method="post"
                    action="{% url 'dashboard:session_start' pk=game_task.id session_id=session.id %}"
                    class="flex justify-center"
                >
                    {% csrf_token %}
                    <button 
                        type="submit"
                        class="relative grid cursor-pointer group"
                    >  
                        <span class="absolute -bottom-1.5 w-full h-full rounded-xl bg-primary-800 group-active:h-0"></span>
                        <span class="
                            relative w-full px-4 py-2 rounded-xl bg-primary-600 text-white font-medium 
                            group-hover:bg-primary-500 group-active:translate-y-1.5
                            "
                        >
                            Сессияны бастау
                        </span>
                    </button>
                </form>

                <!-- Баптаулар -->
                <div x-data="{ settings: false }">
                    <button 
                        x-on:click.prevent="settings = !settings"
                        type="button" 
                        class="p-2 rounded-xl cursor-pointer hover:bg-primary-50 active:scale-90"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings">
                            <path
                                d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </button>

                    <div
                        x-show="settings"
                        x-transition.opacity
                        x-cloak
                        @keydown.escape.window="settings = false"
                        @click="settings = false"
                        @close-settings.window="settings = false"
                        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
                    >
                        <div 
                            @click.stop
                            class="grid gap-4 bg-white text-left rounded-2xl shadow-lg w-full max-w-md p-6"
                        >
                            <h3 class="text-xl font-black">Баптаулар</h3>
                            <form
                                method="post"
                                hx-post="{% url 'dashboard:session_settings' pk=game_task.id session_id=session.id %}"
                                hx-on::after-request="
                                    showFlash('Сессия сақталды!', 'success');
                                    window.dispatchEvent(new CustomEvent('close-settings'));
                                "
                                class="space-y-4"
                            >
                                {% csrf_token %}
                                <div class="space-y-2">
                                    <div class="grid">
                                        <label for="session_limit" class="font-bold">Таймер</label>
                                        <span class="text-xs text-muted">Уақытқа шектеу қою</span>
                                    </div>
                                    
                                    <select 
                                        name="session_limit" 
                                        id="session_limit" 
                                        class="w-full px-4 py-2 rounded-xl border border-border-200"
                                    >
                                        <option value="limited" {% if session.session_limit == 'limited' %}selected{% endif %}>Шектеулі</option>
                                        <option value="limitless" {% if session.session_limit == 'limitless' %}selected{% endif %}>Шексіз</option>
                                    </select>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button
                                        type="submit"
                                        class="relative grid cursor-pointer group"
                                    >
                                        <span class="absolute -bottom-1.5 w-full h-full rounded-xl bg-primary-800 group-active:h-0"></span>
                                        <span class="
                                            relative w-full px-4 py-2 rounded-xl bg-primary-600 text-white font-medium 
                                            group-hover:bg-primary-500 group-active:translate-y-1.5
                                            "
                                        >
                                            Сақтау
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-start gap-4">
            <!-- Кіру сілтемелері -->
            <div class="space-y-4">
                <!-- ПИН код -->
                <div class="p-4 border space-y-2 border-border-200 rounded-xl">
                    <h5 class="text-base font-bold">PIN код</h5>
                    <h1 class="text-5xl font-black tracking-widest">{{ session.pin_code }}</h1>
                </div>

                <!-- Сілтемені көшіріп алу -->
                <div class="p-4 border space-y-2 border-border-200 rounded-xl">
                    <h5 class="text-base font-bold">Қатысушылар үшін сілтеме</h5>
                    <div 
                        x-data="{ 
                            copied: false, 
                            copy() {
                                navigator.clipboard.writeText($refs.link.value);
                                this.copied = true;
                                setTimeout(() => this.copied = false, 1500);
                            }     
                        }"
                        class="relative"
                    >
                        <input 
                            type="text"
                            name="link"
                            readonly
                            x-ref="link"
                            value="{{ join_url }}"
                            class="py-2 pr-10 pl-4 rounded-xl border border-border-200"
                        >
                        <button
                            type="button"
                            @click="copy()"
                            class="absolute top-0.5 right-0.5 p-2 rounded-xl text-muted cursor-pointer hover:bg-primary-50"
                        >
                            <svg
                                x-show="!copied" 
                                xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-icon lucide-copy">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                            </svg>
                            <svg
                                x-show="copied" 
                                xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check">
                                <path d="M20 6 9 17l-5-5" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- QR -->
                <div class="p-4 border space-y-2 border-border-200 rounded-xl">
                    <h5 class="text-base font-bold">QR кодты сканерлеңіз:</h5>
                    <input type="hidden" id="join-url" value="{{ join_url }}">
                    <canvas id="qr-code"></canvas>
                    <script>
                        const qr = new QRious({
                            element: document.getElementById('qr-code'),
                            value: "{{ join_url }}",
                            size: 264,
                            level: "H"
                        });
                    </script>
                </div>
            </div>

            <!-- Қатысушылар -->
            <div class="flex-1 grid items-start border border-border-200 rounded-xl">
                <div class="flex items-start justify-between px-4 pb-2 pt-4">
                    <h4 class="text-base font-bold">Қатысушылар</h4>
                </div>

                <div
                    id="participants-list"
                    hx-get="{% url 'dashboard:session_participants_fragment' game_task.id session.id %}"
                    hx-trigger="load, every 5s"
                    hx-target="#participants-list"
                    hx-swap="innerHTML"
                    class="flex-1 w-full h-[548px] overflow-y-auto px-4 py-2"
                >
                    <div class="flex justify-center items-center h-full">
                        <p class="text-muted">Қатысушылар күтілуде...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock base %}