{% extends 'base.html' %}
{% load static %}

{% block title %}{{ game_task.name }} – Бақылау панелі{% endblock title %}

{% block base %}
<div class="w-full">
    <header class="sticky top-0 z-10 border-b bg-white border-border-200">
        <div class="w-full max-w-7xl mx-auto flex justify-between items-center p-4">
            <div class="w-24 flex">
                <img src="{% static 'images/logo.svg' %}" alt="" class="w-full" />
            </div>

            <form 
                method="post"
                action="{% url 'dashboard:session_finish' pk=game_task.pk session_id=session.pk %}"
                class="flex justify-center"
            >
                {% csrf_token %}
                <button type="submit" class="relative grid cursor-pointer group">
                    <span class="absolute -bottom-1.5 w-full h-full rounded-xl bg-primary-800 group-active:h-0"></span>
                    <span class="
                        relative w-full px-4 py-2 rounded-xl bg-primary-600 text-white font-medium 
                        group-hover:bg-primary-500 group-active:translate-y-1.5
                        ">
                        Сессияны аяқтау
                    </span>
                </button>
            </form>
        </div>
    </header>

    <div class="max-w-7xl mx-auto space-y-8 px-4 pt-8">
        <div class="grid gap-4 text-center">
            <h2 class="text-xl md:text-2xl lg:text-3xl xl:text-4xl font-black">
                {{ game_task.name }}
            </h2>
            <div class="flex gap-2 justify-center">
                <div class="inline-flex items-center gap-2 py-2 px-4 rounded-full border border-border-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-circle-dashed-icon lucide-circle-dashed">
                        <path d="M10.1 2.182a10 10 0 0 1 3.8 0" />
                        <path d="M13.9 21.818a10 10 0 0 1-3.8 0" />
                        <path d="M17.609 3.721a10 10 0 0 1 2.69 2.7" />
                        <path d="M2.182 13.9a10 10 0 0 1 0-3.8" />
                        <path d="M20.279 17.609a10 10 0 0 1-2.7 2.69" />
                        <path d="M21.818 10.1a10 10 0 0 1 0 3.8" />
                        <path d="M3.721 6.391a10 10 0 0 1 2.7-2.69" />
                        <path d="M6.391 20.279a10 10 0 0 1-2.69-2.7" />
                    </svg>
                    <div class="flex flex-col text-left">
                        <span class="text-muted text-xs">Статус</span>
                        <span class="font-bold">{{ session.get_status_display }}</span>
                    </div>
                </div>

                <div class="flex gap-2 items-center px-4 py-2 rounded-full border border-border-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-timer-icon lucide-timer">
                        <line x1="10" x2="14" y1="2" y2="2" />
                        <line x1="12" x2="15" y1="14" y2="11" />
                        <circle cx="12" cy="14" r="8" />
                    </svg>
                    <div class="grid text-left">
                        <span class="text-xs text-muted">Қалған уақыт</span>
                        {% if session.session_limit == 'limited' %}
                            <span 
                                id="countdown"
                                class="font-bold" 
                                data-remaining="{{ remaining_seconds }}"
                                data-finish-url="{% url 'dashboard:session_finish' pk=game_task.pk session_id=session.pk %}"
                                data-finished-url="{% url 'dashboard:session_finished' pk=game_task.pk session_id=session.pk %}"
                            >
                                {{ session.remaining_mm_ss }}
                            </span>
                        {% else %}
                            <span class="font-medium">Шектеусіз</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Лидербоард фрагмент -->
        <div 
            id="leaderboard-container"
            hx-get="{% url 'dashboard:session_active_leaderboard' pk=game_task.pk session_id=session.pk %}"
            hx-trigger="load, every 5s" 
            hx-swap="innerHTML"
        >
            <div class="pb-8 text-center text-muted">
                Жүктелуде...
            </div>
        </div>
    </div>
</div>

{% endblock base %}

{% block js %}
<script>
    (function () {
        const el = document.getElementById('countdown');
        if (!el) return;

        let remaining = parseInt(el.dataset.remaining || '0', 10);
        const finishUrl = el.dataset.finishUrl;
        const finishedUrl = el.dataset.finishedUrl;

        function getCookie(name) {
            const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return m ? decodeURIComponent(m[2]) : null;
        }

        function fmt(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}:${String(s).padStart(2, '0')}`;
        }

        async function finishSession() {
            const csrftoken = getCookie('csrftoken');
            try {
                await fetch(finishUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: ''
                });
                window.location.href = finishedUrl;
            } catch (e) {
                console.error('Finish failed:', e);
            }
        }

        el.textContent = fmt(remaining);

        const t = setInterval(() => {
            remaining = Math.max(0, remaining - 1);
            el.textContent = fmt(remaining);
            if (remaining <= 0) {
                clearInterval(t);
                finishSession();
            }
        }, 1000);
    })();
</script>
{% endblock js %}