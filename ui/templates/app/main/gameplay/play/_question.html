            <!-- Таймер -->
            {% if question_limit and question_limit > 0 %}
                <div class="flex items-center justify-between mb-3">
                    <div class="text-xs text-slate-500">
                    Уақыт:
                    <span id="q-timer" class="font-semibold text-slate-800"
                            data-seconds="{{ question_limit }}">--:--</span>
                    </div>

                    <div class="text-xs text-slate-500">
                    Ұпай: <span id="score" class="font-semibold text-slate-800">{{ participant.score }}</span>
                    </div>
                </div>
            {% else %}
                <div class="flex items-center justify-end mb-3 text-xs text-slate-500">
                    Ұпай: <span id="score" class="font-semibold text-slate-800">{{ participant.score }}</span>
                </div>
            {% endif %}

{# 1) Сұрақ мәтіні #}

<h2 class="text-lg font-semibold text-slate-900 mb-4">
    {{ question.body|safe }}
</h2>

{# 2) Прогресс #}
<p class="mb-3 text-xs text-slate-500 text-right">
    Сұрақ {{ index }} / {{ total_questions }}
</p>

{# 3) Жауап беру формасы #}
<form
    id="answer-form"
    method="post"
    action="{% url 'main:gameplay_answer' participant.token %}"
    hx-post="{% url 'main:gameplay_answer' participant.token %}"
    hx-target="#question-container"
    hx-swap="innerHTML"
    class="space-y-3"
>
    {% csrf_token %}

    {% with q_format=question.format.code v_code=question.variant.code|default_if_none:"" %}
        {% if q_format == "test" %}
            {% if options %}
                {# Multiple choice #}
                {% if v_code == "multiple" %}
                    {% for opt in options %}
                        <label class="flex items-start gap-2 border border-border-200 rounded-xl px-3 py-2 cursor-pointer hover:bg-slate-50">
                            <input
                                type="checkbox"
                                name="options"
                                value="{{ opt.id }}"
                                class="mt-1"
                            >
                            <span class="text-sm text-slate-800">
                                {{ opt.answer|safe }}
                            </span>
                        </label>
                    {% endfor %}

                {# Single choice #}
                {% else %}
                    {% for opt in options %}
                        <label class="flex items-start gap-2 border border-border-200 rounded-xl px-3 py-2 cursor-pointer hover:bg-slate-50">
                            <input
                                type="radio"
                                name="options"
                                value="{{ opt.id }}"
                                class="mt-1"
                            >
                            <span class="text-sm text-slate-800">
                                {{ opt.answer|safe }}
                            </span>
                        </label>
                    {% endfor %}
                {% endif %}

            {% else %}
                <p class="text-sm text-slate-500">Бұл тест сұраққа жауап нұсқалары анықталмаған.</p>
            {% endif %}

        {% elif q_format == "open" %}
            <textarea
                name="answer"
                rows="3"
                class="w-full border border-border-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-primary-600"
                placeholder="Жауабыңызды жазыңыз..."
            ></textarea>

        {% else %}
            <p class="text-sm text-slate-500">
                Бұл форматтағы сұрақ әзірге конфигурацияланбаған ({{ q_format }}).
            </p>
        {% endif %}

    {% endwith %}

    <button
        type="submit"
        class="w-full mt-4 rounded-xl bg-primary-600 text-white py-2.5 text-sm font-medium hover:bg-primary-700 active:scale-95 transition"
    >
        Жауап беру
    </button>
</form>


{% if question_limit and question_limit > 0 %}
<script>
    (function () {
        // HTMX әр swap-та қайта скрипт жүреді — бұрынғы интервалды тоқтатамыз
        if (window.__qTimerInterval) {
            clearInterval(window.__qTimerInterval);
            window.__qTimerInterval = null;
        }

        const el = document.getElementById('q-timer');
        const form = document.getElementById('answer-form');
        if (!el || !form) return;

        let seconds = parseInt(el.dataset.seconds || "0", 10);
        if (!Number.isFinite(seconds) || seconds <= 0) return;

        function render() {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            el.textContent = `${m}:${String(s).padStart(2, '0')}`;
            if (seconds <= 5) el.classList.add('text-rose-600');
        }
        render();

        window.__qTimerInterval = setInterval(() => {
            seconds -= 1;
            if (seconds <= 0) {
                clearInterval(window.__qTimerInterval);
                window.__qTimerInterval = null;

                // пайдаланушы қайта баспасын деп disable
                form.querySelectorAll('input, textarea, button').forEach(x => x.disabled = true);

                // авто-submit: ештеңе таңдалмаса -> selected_ids бос болады -> қате болады
                if (window.htmx) {
                    htmx.trigger(form, 'submit');
                } else {
                    form.requestSubmit();
                }
                return;
            }
            render();
        }, 1000);
    })();
</script>
{% endif %}