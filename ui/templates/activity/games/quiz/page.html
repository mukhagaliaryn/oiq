{% extends 'base.html' %}
{% load static %}

{% block title %}{{ participant.nickname }} - {{ game_task.name }}{% endblock %}

{% block base %}
<div class="min-h-screen flex justify-center items-center">
    <!-- Басы -->
    <header id="gameplay-header" class="fixed left-0 top-0 z-10 w-full bg-white border-b border-border-200">
        <div class="max-w-5xl mx-auto flex justify-between items-center gap-4 p-4">
            <!-- Ұпай -->
            <div class="flex items-center gap-2 py-2 px-4 rounded-xl bg-secondary-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" class="text-amber-500"
                    viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z"
                        clip-rule="evenodd" />
                </svg>
                <span id="ui-score" class="font-bold">{{ participant.score }}</span>
            </div>
            
            <!-- Прогресс -->
            <div class="flex-1 flex flex-col gap-1">
                <div class="flex justify-between text-xs text-subtle">
                    <span>Сұрақ</span>
                    <span id="ui-progress-text">{{ index }}/{{ total_questions }}</span>
                </div>

                <div class="w-full h-4 rounded-full bg-secondary-200 overflow-hidden">
                    <div
                        id="ui-progress-bar"
                        class="h-full bg-primary-600 transition-[width] duration-300"
                        style="width: 0%"
                    ></div>
                </div>
            </div>

            <!-- Таймер -->
            <div class="flex items-center gap-2 pe-2 ps-4 py-2 rounded-xl bg-secondary-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-timer-icon lucide-timer">
                    <line x1="10" x2="14" y1="2" y2="2" />
                    <line x1="12" x2="15" y1="14" y2="11" />
                    <circle cx="12" cy="14" r="8" />
                </svg>
                <span id="ui-timer" class="font-bold w-12 text-center" data-seconds="0">
                    {% if show_timer %}--:--{% else %}Infinity{% endif %}
                </span>
            </div>
        </div>
    </header>
    <div id="gameplay-header" class="pt-24"></div>

    <!-- Сұрақ бөлімі -->
    <main class="w-full px-4">
        <div id="question-container" class="max-w-xl mx-auto">
            <div 
                hx-get="{% url 'main:gameplay_question' participant.token %}" 
                hx-trigger="load"
                hx-target="#question-container" 
                hx-swap="innerHTML"
            >
                <div class="flex justify-center">
                    <span class="text-muted">Сұрақ жүктелуде...</span>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Сигналдар -->
<div id="sounds">
    <span id="ui-sfx-signal" data-kind="none" class="hidden"></span>
    <audio id="sfx-success" preload="auto">
        <source src="{% static 'sounds/success.mp3' %}" type="audio/mpeg">
    </audio>
    <audio id="sfx-error" preload="auto">
        <source src="{% static 'sounds/error.mp3' %}" type="audio/mpeg">
    </audio>
    <audio id="sfx-finish" preload="auto">
        <source src="{% static 'sounds/finish.mp3' %}" type="audio/mpeg">
    </audio>
</div>


<script>
    (function () {
        function play(kind) {
            let el = null;
            if (kind === "success") el = document.getElementById("sfx-success");
            if (kind === "error") el = document.getElementById("sfx-error");
            if (kind === "finish") el = document.getElementById("sfx-finish");

            if (!el) return;
            el.currentTime = 0;
            el.volume = 0.5;
            el.play().catch(() => { });
        }

        document.addEventListener("htmx:afterSwap", () => {
            const sig = document.getElementById("ui-sfx-signal");
            if (!sig) return;
            const kind = sig.dataset.kind;
            if (kind && kind !== "none") {
                play(kind);
                sig.dataset.kind = "none";
            }
        });
    })();
</script>

<script>
    (function () {
        function renderTimer(el, seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            el.textContent = `${m}:${String(s).padStart(2, "0")}`;
            if (seconds <= 5) el.classList.add("text-destructive");
            else el.classList.remove("text-destructive");
        }

        function setupTimerFromDataset() {
            const timer = document.getElementById('ui-timer');
            const form = document.getElementById('answer-form');
            if (!timer) return;

            if (window.__qTimerInterval) {
                clearInterval(window.__qTimerInterval);
                window.__qTimerInterval = null;
            }

            let seconds = parseInt(timer.dataset.seconds || "0", 10);
            if (!Number.isFinite(seconds) || seconds <= 0) {
                timer.textContent = "--:--";
                timer.classList.remove("text-destructive");
                return;
            }

            renderTimer(timer, seconds);

            window.__qTimerInterval = setInterval(() => {
                seconds -= 1;
                if (seconds <= 0) {
                    clearInterval(window.__qTimerInterval);
                    window.__qTimerInterval = null;

                    if (form) {
                        if (!form.querySelector('input[name="timeout"]')) {
                            const inp = document.createElement('input');
                            inp.type = "hidden";
                            inp.name = "timeout";
                            inp.value = "1";
                            form.appendChild(inp);
                        }

                        form.querySelectorAll("input, textarea").forEach(x => {
                            if (x.name === "csrfmiddlewaretoken" || x.type === "hidden") return;
                            x.disabled = true;
                        });
                        form.requestSubmit();
                    }
                    return;
                }
                renderTimer(timer, seconds);
            }, 1000);
        }

        document.addEventListener("DOMContentLoaded", setupTimerFromDataset);
        document.addEventListener('htmx:afterSwap', setupTimerFromDataset);
    })();
</script>
{% endblock %}